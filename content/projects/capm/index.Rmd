---
title: "Capital Asset Pricing Model"
author: "Yutao Jin"
date: "14 October 2020"
output:
  html_document:
    theme: flatly
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: show
---

```{r, setup, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r,load_libraries, echo=FALSE}
library(mosaic)   # Load additional packages here 
library(tidyverse)  # Loads tidyquant, tidyverse, lubridate, xts, quantmod, TTR 
library(ggformula)
library(GGally)
library(tidyquant)
library(ggfortify)
library(rvest)
library(janitor)
```

```{r echo=FALSE, out.width="100%"}
knitr::include_graphics("C:/Data Analytics/my_website/content/projects/capm/capm.jpg")
```





> Capital Asset Pricing Model (CAPM) is one of the most important models in finance and is the basic of many investment theorys. The model is specified as Ri=Rf+β(Rm-Rf)+e, where Ri is return of stock i, Rm is market average return, and Rf is riskfree rate. In investment evaluation, we always split our return into two parts: alpha return and beta return. Beta return is the incentive of taking systematic market risk and alpha return is generated by investors' ability. Therefore, to evaluate whether investors beat the market, we must estimate the beta of their portfolios. In this blog, I use regression to estimate beta of stocks.


# Data Initialization

I choose the [Dow Jones Industrial Aveareg (DJIA)](https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average) stocks and their ticker symbols and download some data. Besides the thirty stocks that make up the DJIA, I will also add `SPY` which is an SP500 ETF (Exchange Traded Fund) as the market return.

```{r}
djia_url <- "https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average"

# get tables that exist on URL
tables <- djia_url %>% 
  read_html() %>% 
  html_nodes(css="table")

# parse HTML tables into a dataframe called djia. 
# Use purr::map() to create a list of all tables in URL
djia <- map(tables, . %>% 
               html_table(fill=TRUE)%>% 
               clean_names())

# constituents
table1 <- djia[[2]] %>% # the second table on the page contains the ticker symbols
  mutate(date_added = ymd(date_added),
         
         # if a stock is listed on NYSE, its symbol is, e.g., NYSE: MMM
         # We will get prices from yahoo finance which requires just the ticker
         
         # if symbol contains "NYSE*", the * being a wildcard
         # then we jsut drop the first 6 characters in that string
         ticker = ifelse(str_detect(symbol, "NYSE*"),
                          str_sub(symbol,7,11),
                          symbol)
         )

# we need a vector of strings with just the 30 tickers + SPY
tickers <- table1 %>% 
  select(ticker) %>% 
  pull() %>% # pull() gets them as a sting of characters
  c("SPY") # and lets us add SPY, the SP500 ETF
```

Next I am going to download stock prices data using `tidyquant` package.

```{r}
myStocks <- tickers %>%
  tq_get(get  = "stock.prices",
         from = "2011-08-31",
         to   = "2020-09-30") %>%
  group_by(symbol) 

str(myStocks) # examine the structure of the resulting data frame
```

For each ticker symbol, the data frame contains its `symbol`, the `date`, the prices for `open`,`high`, `low` and `close`, and the `volume`, or how many stocks were traded on that day. More importantly, the data frame contains the `adjusted` closing price, which adjusts for any stock splits and/or dividends paid and this is what I will be using for my analyses.

The next step is to calculate returns based on closing price. I will use monthly return in my analyses.

```{r}

#calculate monthly  returns
myStocks_returns_monthly <- myStocks %>%
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "monthly", 
               type       = "arithmetic",
               col_rename = "monthly.returns") 

```

```{r}
#just keep the period returns grouped by symbol
monthly_capm_returns <- myStocks_returns_monthly %>%
            spread(key = symbol, value = monthly.returns)  
```


# Estimate beta

To simplify, I use the linear regression model specified as Ri=α+β*Rm. Firstly, I only focus on one stock: AAPL.

```{r}

ggplot(monthly_capm_returns, aes(x=SPY, y = AAPL))+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)

aapl_capm <- lm(AAPL ~ SPY, data = monthly_capm_returns)
mosaic::msummary(aapl_capm)

autoplot(aapl_capm)
```

The fitted model is Ri=0.0099+1.2158*Rm, where coefficient of Rm is significant at 1% level. I also plot the residuals vs. the fitted (or predicted) values. This is a standard regression diagnostic plot to check whether there is no pattern in the residuals, as well as to test for heteroscedasticity, or whether the residuals appear to have unequal, non-constant variance.

The second thing we must check is whether the residuals follow a Normal distribution. A normal scores, or a QQ plot,  allows us to check for skewness, kurtosis and outliers. (Note that the heteroscedasticity may show as apparent non-normality.)

As we can see from the charts, there's no pattern in the residuals and it follows a normal distribution.

However, it's inefficient to conduct regression for each stock, especially when we have a large number of stocks to analyze. Actually, in `tidyquant` package, we can easily estimate $\beta$ for multiple stocks. To use the `tidyquant::tq_performance` function, I first rearrange the dataframe.

```{r}
capm_df<-myStocks_returns_monthly %>%
  filter(symbol!="SPY")

marketret<-myStocks_returns_monthly %>%
  filter(symbol=="SPY") %>%
  rename(marketret=monthly.returns)

capm_df<-left_join(capm_df,marketret,by="date") %>%
  select(symbol.x,date,monthly.returns,marketret) %>%
  rename(symbol=symbol.x)

```

Next, I use `tidyquant::tq_performance` to evaluate each stock performance with CAPM.

```{r}
capm_table<-capm_df %>%
  group_by(symbol) %>%
  tq_performance(Ra=monthly.returns,
                 Rb=marketret,
                 performance_fun=table.CAPM)

capm_table
```

This table provides many other informative evaluating indicators such as Treynor Ratio. However, in this case, I only focus on Alpha and Beta.

```{r}
capm_table %>%
  select(symbol,Alpha,Beta) %>%
  arrange(desc(Beta))

capm_table %>%
  select(symbol,Alpha,Beta) %>%
  arrange(desc(Alpha))


```

The results show DOW, GS, and JPM are three stocks with highest Beta, while WMT, VZ, MRK are three stocks with lowest Beta. This provides some insights for investment decision. Generally speaking, during a bull market, we should buy stocks with high beta to benefit from overall market soaring while during the bear market, we should buy defending stocks, namely those stocks with low beta.

Another factor in CAPM is Alpha. As we can see from the table, UNH, NKE, and V are three stocks with highest Alpha, indicating these stocks have a premium over the market during the past 10 years. This may result from company's growth potential and prospect.




















